<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>CLOVA Speech API 웹 페이지 예제</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f4f4f9; }
        h1, h2 { color: #333; }
        .container { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; width: 90%; max-width: 600px; }
        textarea { width: 100%; height: 80px; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        #recordBtn { background-color: #e53935; color: white; }
        #recordBtn.recording { background-color: #2e7d32; }
        #playBtn { background-color: #1e88e5; color: white; }
        #status { margin-top: 10px; color: #555; font-style: italic; }
    </style>
</head>
<body>

    <h1>Clova Speech API 예제</h1>

    <div class="container">
        <h2>음성 인식 (STT)</h2>
        <button id="recordBtn">녹음 시작</button>
        <textarea id="sttResult" placeholder="음성 인식 결과가 여기에 표시됩니다."></textarea>
        <div id="status">대기 중...</div>
    </div>

    <div class="container">
        <h2>음성 합성 (TTS)</h2>
        <textarea id="ttsInput" placeholder="음성으로 변환할 텍스트를 입력하세요.">안녕하세요, 네이버 클라우드 플랫폼입니다.</textarea>
        <button id="playBtn">음성으로 듣기</button>
    </div>

    <script>
        const CLIENT_ID = 'YOUR_CLIENT_ID';
        const CLIENT_SECRET = 'vo9s7U2JSITKyIX0ikRPPXEinsSfwWFsZTSKRVNd';

        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];

        const recordBtn = document.getElementById('recordBtn');
        const sttResultTextarea = document.getElementById('sttResult');
        const statusDiv = document.getElementById('status');
        
        const playBtn = document.getElementById('playBtn');
        const ttsInputTextarea = document.getElementById('ttsInput');

        // --- 음성 인식 (STT) 관련 스크립트 ---
        recordBtn.onclick = async () => {
            if (!isRecording) {
                // 녹음 시작
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        audioChunks = [];
                        recognizeSpeech(audioBlob);
                    };

                    mediaRecorder.start();
                    recordBtn.textContent = '녹음 중지';
                    recordBtn.classList.add('recording');
                    statusDiv.textContent = '녹음 중...';
                    isRecording = true;
                } catch (error) {
                    console.error("마이크 접근 오류:", error);
                    statusDiv.textContent = '마이크에 접근할 수 없습니다.';
                }
            } else {
                // 녹음 중지
                mediaRecorder.stop();
                recordBtn.textContent = '녹음 시작';
                recordBtn.classList.remove('recording');
                statusDiv.textContent = '음성 인식 처리 중...';
                isRecording = false;
            }
        };

        async function recognizeSpeech(audioBlob) {
            const url = `/api/stt`; // 실제 서비스에서는 CORS 문제로 서버 프록시가 필요합니다.
            
            // 직접 API 호출 예시 (CORS 문제 발생 가능)
            const apiUrl = 'https://naveropenapi.apigw.ntruss.com/recog/v1/stt?lang=Kor';
            
            const formData = new FormData();
            formData.append('media', audioBlob);

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'X-NCP-APIGW-API-KEY-ID': CLIENT_ID,
                        'X-NCP-APIGW-API-KEY': CLIENT_SECRET,
                        'Content-Type': 'application/octet-stream' // FormData 사용 시 브라우저가 자동 설정하므로 생략 가능
                    },
                    body: audioBlob // Blob 직접 전송
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status}`);
                }

                const result = await response.json();
                sttResultTextarea.value = result.text;
                statusDiv.textContent = '음성 인식 완료';
            } catch (error) {
                console.error('STT API 오류:', error);
                statusDiv.textContent = '음성 인식 실패. 콘솔을 확인하세요.';
            }
        }

        // --- 음성 합성 (TTS) 관련 스크립트 ---
        playBtn.onclick = async () => {
            const text = ttsInputTextarea.value;
            if (!text.trim()) {
                alert('텍스트를 입력하세요.');
                return;
            }

            const url = `/api/tts`; // 실제 서비스에서는 서버 프록시가 필요합니다.
            
            // 직접 API 호출 예시 (CORS 문제 발생 가능)
            const apiUrl = 'https://naveropenapi.apigw.ntruss.com/tts-premium/v1/tts';

            const params = new URLSearchParams({
                speaker: 'nara',
                volume: '0',
                speed: '0',
                pitch: '0',
                format: 'mp3',
                text: text
            }).toString();

            try {
                const response = await fetch(`${apiUrl}?${params}`, {
                    method: 'POST',
                    headers: {
                        'X-NCP-APIGW-API-KEY-ID': CLIENT_ID,
                        'X-NCP-APIGW-API-KEY': CLIENT_SECRET,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status}`);
                }
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                
            } catch (error) {
                console.error('TTS API 오류:', error);
                alert('음성 합성 실패. 콘솔을 확인하세요.');
            }
        };

    </script>
</body>
</html>